#+TITLE: Emacs configuration file
#+AUTHOR: Bernhard Specht
#+BABEL: :cache yes
#+PROPERTY: header-args :tangle yes

* Initalisation
  Byte compile after save
  #+BEGIN_SRC emacs-lisp
    (defun tangle-init ()
      "If the current buffer is 'init.org' the code-blocks are tangled, and the tangled file is compiled."
      (when (equal (buffer-file-name)
                   (expand-file-name (concat user-emacs-directory "init.org")))
        ;; Avoid running hooks when tangling.
        (let ((prog-mode-hook nil))
          (org-babel-tangle)
          (byte-compile-file (concat user-emacs-directory "init.el")))))
    (add-hook 'after-save-hook 'tangle-init)
   #+END_SRC

  Add =melpa= as source for getting packages
  #+BEGIN_SRC emacs-lisp
    (require 'package)
    (setq package-enable-at-startup nil)
    (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/"))
    (package-initialize)
  #+END_SRC

  Bootstrap use-package
  #+BEGIN_SRC emacs-lisp
    (unless (package-installed-p 'use-package)
      (package-refresh-contents)
      (package-install 'use-package))

    (require 'use-package)
  #+END_SRC

  Let Emacs start as server for shell clients.
  #+BEGIN_SRC emacs-lisp
    (server-start)
  #+END_SRC
* File-to-Mode mapping
  Define via filename or extension the major mode for editing
  #+BEGIN_SRC emacs-lisp
    (add-to-list 'auto-mode-alist '("\\.pdf\\'" . pdf-tools-install))
    (add-to-list 'auto-mode-alist '("\\.cpp$" . c++-mode))
    (add-to-list 'auto-mode-alist '("\\.hpp$" . c++-mode))
    (add-to-list 'auto-mode-alist '("\\.tpp$" . c++-mode))
    (add-to-list 'auto-mode-alist '("\\.psgi$" . cperl-mode))
    (add-to-list 'auto-mode-alist '("\\.t\\'"  . cperl-mode))
    (add-to-list 'auto-mode-alist '("cpanfile" . cperl-mode))
    (add-to-list 'auto-mode-alist '("\\.phtml\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.inc\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.tpl\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.php\\'" . php-mode))
    (add-to-list 'auto-mode-alist '("\\.blade\\.php\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.jsp\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.as[cp]x\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.erb\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.mustache\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.djhtml\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.*tpl\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.*tml\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("/\\(views\\|html\\|templates\\)/.*\\.php\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.*tt\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.*tt2\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.nqp\\'" . perl6-mode))
    (add-to-list 'auto-mode-alist '("\\.js\\'" . js2-mode))
    (add-to-list 'auto-mode-alist '("\\.puml\\'" . puml-mode))
    (add-to-list 'auto-mode-alist '("\\.plantuml\\'" . puml-mode))
  #+END_SRC

* Convenience
  Answering with "yes" and "no" is annoying. Use "y" and "n" instead.
  #+BEGIN_SRC emacs-lisp
    (fset 'yes-or-no-p 'y-or-n-p)
  #+END_SRC

  Autosave into one single directory
  #+BEGIN_SRC emacs-lisp
    (defvar emacs-autosave-directory
      (concat user-emacs-directory "autosaves/")
      "This variable dictates where to put auto saves. It is set to a
          directory called autosaves located wherever your .emacs.d/ is
          located.")

    (setq backup-directory-alist
          `((".*" . ,emacs-autosave-directory))
          auto-save-file-name-transforms
          `((".*" ,emacs-autosave-directory t)))
  #+END_SRC

  Only tabs
  #+BEGIN_SRC emacs-lisp
    (setq-default indent-tabs-mode nil)
  #+END_SRC

  Some usefull defaults
  #+BEGIN_SRC emacs-lisp
    (setq auto-revert-interval 1            ; Refresh buffers fast
          custom-file (make-temp-file "")   ; Discard customization's
          default-input-method "TeX"        ; Use TeX when toggling input method
          echo-keystrokes 0.1               ; Show keystrokes asap
          inhibit-startup-message t         ; No splash screen please
          initial-scratch-message nil       ; Clean scratch buffer
          recentf-max-saved-items 100       ; Show more recent files
          ring-bell-function 'ignore        ; Quiet
          sentence-end-double-space nil     ; No double space
          set-language-environment "UTF-8") ; utf8 everywhere
  #+END_SRC

  Provide help for keybindings.
  #+BEGIN_SRC emacs-lisp
    (use-package which-key
      :ensure t
      :config
      (which-key-mode 1))
  #+END_SRC

  Expand region for selecting regions
  #+BEGIN_SRC emacs-lisp
    (use-package expand-region
      :ensure t
      :bind (("C-M-<space>" . er/expand-region)))
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    ;; (add-hook 'before-save-hook 'delete-trailing-whitespace)
  #+END_SRC

* Appearance
  Disable all gui bars
  #+BEGIN_SRC emacs-lisp
    (dolist (mode
             '(tool-bar-mode                ; No toolbars, more room for text
               scroll-bar-mode              ; No scroll bars either
               blink-cursor-mode            ; The blinking cursor gets old
               menu-bar-mode))              ; No menu-bar
      (funcall mode 0))
  #+END_SRC

  Use the dark atom theme
  #+BEGIN_SRC emacs-lisp
    (use-package atom-dark-theme
      :ensure t
      :config
      (load-theme 'atom-dark 'NO-CONFIRM))
  #+END_SRC

  Mark matching brackets
  #+BEGIN_SRC emacs-lisp
    (use-package smartparens
      :ensure t
      :config
      (require 'smartparens-config)
      (show-paren-mode 1))
  #+END_SRC

* Projekt Management
  Manage projects with =projectile=
  #+BEGIN_SRC emacs-lisp
    (use-package projectile
      :ensure t
      :config
      (projectile-mode 1))
  #+END_SRC

  Project explorer, rarely used
  #+BEGIN_SRC emacs-lisp
    (use-package neotree
      :ensure t
      :config
      (global-set-key [f2] 'neotree-toggle)
      (setq neo-theme (if (display-graphic-p) 'icons 'arrow)))
  #+END_SRC

  Diff directories, projects and stuff
  #+BEGIN_SRC emacs-lisp
    (use-package ztree
      :ensure t)
  #+END_SRC

* ivy - Awesome interface for nearly everything
  ivy with some usefull defaults.
  #+BEGIN_SRC emacs-lisp
    (use-package ivy :ensure t
      :diminish (ivy-mode . "")
      :bind (("C-x b" . ivy-switch-buffer))
      :config
      (ivy-mode 1)
      ;; add ‘recentf-mode’ and bookmarks to ‘ivy-switch-buffer’.
      (setq ivy-use-virtual-buffers t)
      ;; number of result lines to display
      (setq ivy-height 30)
      ;; no regexp by default
      (setq ivy-initial-inputs-alist nil)
      (setq magit-completing-read-function 'ivy-completing-read)
      (setq completion-in-region-function 'ivy-completion-in-region)
      ;; configure regexp engine.
      (setq ivy-re-builders-alist
            ;; allow input not in order
            '((t   . ivy--regex-ignore-order)))
      (define-key ivy-mode-map (kbd "C-'") 'ivy-avy))
  #+END_SRC

  replacement for helm-swoop
  #+BEGIN_SRC emacs-lisp
    (use-package swiper
      :ensure t
      :config
      :bind (("M-o" . swiper)))
  #+END_SRC

  smex for M-x ranking
  #+BEGIN_SRC emacs-lisp
    (use-package smex
      :ensure t
      :config
      (smex-initialize)
      (setq smex-completion-method 'ivy))
  #+END_SRC

  use counsel as well
  #+BEGIN_SRC emacs-lisp
    (use-package counsel
      :ensure t
      :config
      :bind (("C-c h" . counsel-descbinds)
             ("M-x" . counsel-M-x)
             ("M-y" . counsel-yank-pop)
             ("C-c C-r" . counsel-recentf)
             ("M-p" . ag-project)
             ("C-c l" . counsel-locate)
             ("C-x C-f" . counsel-find-file)))
  #+END_SRC

  let ivy interface with projectile
  #+BEGIN_SRC emacs-lisp
    (use-package counsel-projectile
      :ensure t
      :config
      (counsel-projectile-on))
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package ivy-rich
      :ensure t
      :config
      (ivy-set-display-transformer 'ivy-switch-buffer 'ivy-rich-switch-buffer-transformer)
      (setq ivy-virtual-abbreviate 'full
      ivy-rich-switch-buffer-align-virtual-buffer t))
  #+END_SRC

* Auto Completion
  Complete-Anything!
  #+BEGIN_SRC emacs-lisp
    (use-package company
      :ensure t
      :config
      (setq company-idle-delay 0
            company-echo-delay 0
            company-dabbrev-downcase nil
            company-minimum-prefix-length 1
            ompany-tooltip-limit 20
            company-selection-wrap-around t
            company-transformers '(company-sort-by-occurrence
                                   company-sort-by-backend-importance))
      (define-key company-mode-map (kbd "C-TAB") 'counsel-company)
      (global-company-mode))
  #+END_SRC

  Fit completion popup to theme
  #+BEGIN_SRC emacs-lisp
    (require 'color)
    (let ((bg (face-attribute 'default :background)))
      (custom-set-faces
       `(company-tooltip ((t (:inherit default :background ,(color-lighten-name bg 2)))))
       `(company-scrollbar-bg ((t (:background ,(color-lighten-name bg 10)))))
       `(company-scrollbar-fg ((t (:background ,(color-lighten-name bg 5)))))
       `(company-tooltip-selection ((t (:inherit font-lock-function-name-face))))
       `(company-tooltip-common ((t (:inherit font-lock-constant-face))))))
  #+END_SRC

  For snippets =yasnippet= with company backend.
  #+BEGIN_SRC emacs-lisp
    (use-package yasnippet
      :ensure t
      :config
      (yas-global-mode 1))
  #+END_SRC

  Fuzzy complete
  #+BEGIN_SRC emacs-lisp
    (use-package company-flx
      :ensure t
      :config
      (with-eval-after-load 'company
        (add-hook 'company-mode-hook (lambda ()
                                       (add-to-list 'company-backends 'company-capf)))
        (company-flx-mode +1)))
  #+END_SRC

* Syntax/Spell Checking
  =flycheck= as syntax checker interface
  #+BEGIN_SRC emacs-lisp
    (use-package flycheck
      :ensure t
      :config
      (global-flycheck-mode))

  #+END_SRC

  =flyspell= as spell checker interace together
  #+BEGIN_SRC emacs-lisp
    (use-package flyspell
      :ensure t
      :config
      (setq flyspell-issue-message-flag nil)) ; performance
  #+END_SRC

* Common functions
  Rename current buffer and file
  #+BEGIN_SRC emacs-lisp
    (defun rename-file-and-buffer (new-name)
      "Renames both current buffer and file it's visiting to NEW-NAME."
      (interactive "sNew name: ")
      (let ((name (buffer-name))
            (filename (buffer-file-name)))
        (if (not filename)
            (message "Buffer '%s' is not visiting a file!" name)
          (if (get-buffer new-name)
              (message "A buffer named '%s' already exists!" new-name)
            (progn
              (rename-file name new-name 1)
              (rename-buffer new-name)
              (set-visited-file-name new-name)
              (set-buffer-modified-p nil))))))
  #+END_SRC

  Kill all buffers except current
  #+BEGIN_SRC emacs-lisp
  (defun kill-other-buffers ()
    "Kill all other buffers."
    (interactive)
    (mapc 'kill-buffer
          (delq (current-buffer) (buffer-list))))
  #+END_SRC

  Use perl tidy on regions and functions
  #+BEGIN_SRC emacs-lisp
    (defun perltidy-region ()
      "Run perltidy on the current region."
      (interactive)
      (save-excursion
        (shell-command-on-region (point) (mark) "perltidy-sweet -q" nil t)))

    (defun perltidy-defun ()
      "Run perltidy on the current defun."
      (interactive)
      (save-excursion (mark-defun)
                      (perltidy-region)))
  #+END_SRC

  some other usefull functions
  #+BEGIN_SRC emacs-lisp
    (defun perl-path-to-namespace()
      (interactive)
      (replace-regexp-in-string
       "^::\\|.pm$" "" (replace-regexp-in-string
                        "/" "::" (replace-regexp-in-string
                                  (expand-file-name "lib" (projectile-project-root)) "" buffer-file-name))))

    (defun toggle-maximize-buffer () "Maximize buffer"
           (interactive)
           (if (= 1 (length (window-list)))
               (jump-to-register '_)
             (progn
               (set-register '_ (list (current-window-configuration)))
               (delete-other-windows))))

    (defun random-sort-lines (beg end) "Sort lines in region randomly."
      (interactive "r")
      (save-excursion
        (save-restriction
          (narrow-to-region beg end)
          (goto-char (point-min))
          (let ;; To make `end-of-line' and etc. to ignore fields.
              ((inhibit-field-text-motion t))
            (sort-subr nil 'forward-line 'end-of-line nil nil
                       (lambda (s1 s2) (eq (random 2) 0)))))))
  #+END_SRC

* Web Development
  Interact with browser using =skewer=
  #+BEGIN_SRC emacs-lisp
    (use-package skewer-mode
      :ensure t
      :config
      (add-hook 'js2-mode-hook 'skewer-mode)
      (add-hook 'css-mode-hook 'skewer-css-mode)
      (add-hook 'html-mode-hook 'skewer-html-mode))
  #+END_SRC

  Use =web-mode= as major mode for =html, ...=
  #+BEGIN_SRC emacs-lisp
    (use-package web-mode
      :ensure t
      :defer t
      :config
      (setq-default web-mode-enable-auto-pairing t
                    web-mode-enable-auto-opening t
                    web-mode-enable-auto-indentation t
                    web-mode-enable-block-face t
                    web-mode-enable-part-face t
                    web-mode-enable-comment-keywords t
                    web-mode-enable-css-colorization t
                    web-mode-enable-current-element-highlight t
                    web-mode-enable-heredoc-fontification t
                    web-mode-enable-engine-detection t
                    web-mode-markup-indent-offset 2
                    web-mode-css-indent-offset 2
                    web-mode-code-indent-offset 2
                    web-mode-style-padding 2
                    web-mode-script-padding 2
                    web-mode-block-padding 0
                    web-mode-comment-style 2)
      (custom-set-faces
       '(web-mode-html-tag-face
         ((t (:foreground "#729fcf"))))
       '(web-mode-html-tag-bracket-face
         ((t (:foreground "#FFE84B"))))
       '(web-mode-current-element-highlight-face
         ((t (:foreground "#FF8A4B"))))
       '(web-mode-current-element-highlight-face
         ((t (:background "#000000"
                          :foreground "#FF8A4B")))))
      (define-key helm-map (kbd "C-c C-e") 'web-mode-element-close)
      (add-hook 'web-mode-hook
                '(lambda ()
                   (local-set-key (kbd "RET") 'newline-and-indent)
                   (setq smartparens-mode nil)))
      (add-hook 'web-mode-before-auto-complete-hooks
                  '(lambda ()
                     (let ((web-mode-cur-language
                            (web-mode-language-at-pos)))
                       (if (string= web-mode-cur-language "php")
                           (yas-activate-extra-mode 'php-mode)
                         (yas-deactivate-extra-mode 'php-mode))
                       (if (string= web-mode-cur-language "css")
                           (setq emmet-use-css-transform t)
                         (setq emmet-use-css-transform nil))))))
  #+END_SRC

  =company-web= for auto complete in web mode
  #+BEGIN_SRC emacs-lisp
    (use-package company-web
      :ensure t
      :defer t
      :config
      (add-to-list 'company-backends '(company-web-html))
      (add-to-list 'company-backends '(company-web-jade)))
  #+END_SRC

* Javascript/TypeScript
  Use =js2-mode= as mojor mode for editing Javascript
  #+BEGIN_SRC emacs-lisp
    (use-package js2-mode
      :ensure t)
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package json-mode
      :ensure t)
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (defun setup-tide-mode ()
      (interactive)
      (tide-setup)
      (flycheck-mode +1)
      (setq flycheck-check-syntax-automatically '(save mode-enabled))
      (eldoc-mode +1)
      (tide-hl-identifier-mode +1)
      ;; company is an optional dependency. You have to
      ;; install it separately via package-install
      ;; `M-x package-install [ret] company`
      (company-mode +1))

    (use-package tide
      :ensure t
      :config
      (add-hook 'typescript-mode-hook #'setup-tide-mode))
  #+END_SRC
* PHP
  use =php-mode=
  #+BEGIN_SRC emacs-lisp
    (use-package php-mode
      :ensure t)
  #+END_SRC

* Perl/Perl6
  =cperl-mode= prefered to =perl-mode=
  #+BEGIN_SRC emacs-lisp
    (defalias 'perl-mode 'cperl-mode)
    (use-package cperl-mode
      :ensure t
      :bind (("C-c p" . perltidy-region)
             ("C-c f" . perltidy-defun))
      :config
    (custom-set-faces
     '(cperl-hash-face  ((t)))
     '(cperl-array-face ((t))))
    (setq
        cperl-close-paren-offset -4
        cperl-continued-statement-offset 4
        cperl-indent-level 4
        cperl-tab-always-indent t
        cperl-indent-parens-as-block t)
    (defalias 'perl-mode 'cperl-mode))
  #+END_SRC

  custom =flycheck= checkers to work in carton environment
  #+BEGIN_SRC emacs-lisp
    (flycheck-define-checker my-perl
      "A Perl syntax checker using the Perl interpreter."
      :command ("~/perl5/perlbrew/perls/perl-5.24.0/bin/perl" "-w" "-c"
                (eval (let ((options '()))
                        (when (projectile-project-p)
                          (push (concat "-I" (projectile-project-root)) options)
                          (push (concat "-I" (projectile-expand-root "lib")) options)
                          (when (projectile-verify-file "cpanfile")
                            (push (concat "-I" (projectile-expand-root "local/lib/perl5")) options))
                          options)))
                source)
      :error-patterns ((error line-start (minimal-match (message)) " at " (file-name) " line " line (or "." (and ", " (zero-or-more not-newline))) line-end))
      :modes (perl-mode cperl-mode)
      :next-checkers (my-perl-perlcritic))

    (flycheck-define-checker my-perl-perlcritic
      "A Perl syntax checker using Perl::Critic."
      :command ("perlcritic" "--no-color" "--verbose" "%f:%l:%c:%s:%m (%e)\n"
                (option "--severity" flycheck-perlcritic-verbosity flycheck-option-int)
                source-original)
      :error-patterns ((info    line-start (file-name) ":" line ":" column ":" (any "1")   ":" (message) line-end)
                       (warning line-start (file-name) ":" line ":" column ":" (any "234") ":" (message) line-end)
                       (error   line-start (file-name) ":" line ":" column ":" (any "5")   ":" (message) line-end))
      :modes (cperl-mode perl-mode))

    (add-to-list 'flycheck-checkers 'my-perl)
    (add-to-list 'flycheck-checkers 'my-perl-perlcritic)

    (defun my-cperl-mode-hook ()
      "Hook function for `cperl-mode'."
      (helm-perldoc:carton-setup)
      (flycheck-select-checker 'my-perl))
    (add-hook 'cperl-mode-hook 'my-cperl-mode-hook)
  #+END_SRC

  =helm= to browser perldoc
  #+BEGIN_SRC emacs-lisp
    (use-package helm-perldoc
      :ensure t)
  #+END_SRC

  Perl6 packages
  #+BEGIN_SRC emacs-lisp
    (use-package perl6-mode
      :ensure t)
    (use-package flycheck-perl6
      :ensure t)
  #+END_SRC

* Search and Replace
  =anzu= provides nice visual help during replacing files
  #+BEGIN_SRC emacs-lisp
    (use-package anzu
      :ensure t
      :config
      (setq anzu-mode-lighter ""
            anzu-deactivate-region t
            anzu-search-threshold 1000
            anzu-replace-threshold 50
            anzu-replace-to-string-separator " => ")
      (set-face-attribute 'anzu-mode-line nil
                          :foreground "yellow" :weight 'bold)
      ;(global-anzu-mode +1)
      (global-set-key (kbd "C-c q") 'anzu-query-replace)
      (global-set-key (kbd "C-c r") 'anzu-query-replace-regexp))

  #+END_SRC

  ag/the_silver_searcher standalone and with helm
  #+BEGIN_SRC emacs-lisp
    (use-package ag
      :ensure t
      :bind (("M-s" . counsel-projectile-ag)))
  #+END_SRC

* LaTeX
  Auctex as package for LaTeX
  #+BEGIN_SRC emacs-lisp
    ;(use-package auctex
      ;:ensure t)
  #+END_SRC

  =company-auctex= for latex completion
  #+BEGIN_SRC emacs-lisp
    (use-package company-auctex
      :ensure t
      :config
      (company-auctex-init))
  #+END_SRC

  Preview on the right side
  #+BEGIN_SRC emacs-lisp
    (use-package latex-preview-pane
      :ensure t
      :config
      (latex-preview-pane-enable))
  #+END_SRC

  Hooks for minor modes of LaTeX
  #+BEGIN_SRC emacs-lisp
    (add-hook 'LaTeX-mode-hook 'visual-line-mode)
    (add-hook 'LaTeX-mode-hook 'flyspell-mode)
    (add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)
  #+END_SRC

* C/C++
  Basic offset of 4
  #+BEGIN_SRC emacs-lisp
    (setq c-basic-offset 4)
  #+END_SRC

  =rtags= for jumping around in source code
  #+BEGIN_SRC emacs-lisp
    (use-package flycheck-rtags
      :ensure t)
    (use-package rtags
      :ensure t
      :config
      (require 'flycheck-rtags))
  #+END_SRC

  =irony= for completion
  #+BEGIN_SRC emacs-lisp
    (use-package irony
      :ensure t
      :config
      (add-hook 'c++-mode-hook 'irony-mode)
      (add-hook 'c-mode-hook 'irony-mode)
      (add-hook 'objc-mode-hook 'irony-mode))

    (use-package company-irony
      :ensure t
      :config
      (add-to-list 'company-backends 'company-irony))

    ;; (use-package flycheck-irony
    ;;   :ensure t
    ;;   :config
    ;;   (eval-after-load 'flycheck
    ;;     '(add-hook 'flycheck-mode-hook #'flycheck-irony-setup)))
  #+END_SRC

  Major mode for =CMakeLists.txt= files
  #+BEGIN_SRC emacs-lisp
    (use-package cmake-mode
      :ensure t)
  #+END_SRC

  =cmake-ide= will take care of all includes and module setup
  #+BEGIN_SRC emacs-lisp
    (use-package cmake-ide
      :ensure t
      :config
      (require 'rtags)
      (cmake-ide-setup))
  #+END_SRC

  If =cmake-ide= cannot find correct build dir, provide function to solve issue
  #+BEGIN_SRC emacs-lisp
    (defun set-cmake-ide-build-dir()
      "Set build dir with CompileCommands.json"
      (interactive)
      (let ((dir (read-directory-name "Build dir:")))
        (setq cmake-ide-build-dir dir)))
  #+END_SRC

  Use googles cpp lint checker
  #+BEGIN_SRC emacs-lisp
    ;; (use-package flycheck-google-cpplint
    ;;   :ensure t
    ;;   :config
    ;;   (setq flycheck-googlelint-verbose "3"
    ;;         flycheck-googlelint-filter "-whitespace,+whitespace/braces"
    ;;         flycheck-googlelint-root "/usr/bin/cpplint"
    ;;         flycheck-googlelint-linelength "120"))
  #+END_SRC


  flycheck c++ standard
  #+BEGIN_SRC emacs-lisp
    (add-hook 'c++-mode-hook (lambda () (setq flycheck-clang-language-standard "c++11")))
  #+END_SRC

  disassemble C/C++
  #+BEGIN_SRC emacs-lisp
    (use-package disaster
      :ensure t
      :config
      (define-key c-mode-base-map (kbd "C-c d") 'disaster))
  #+END_SRC

  code formatting
  #+BEGIN_SRC emacs-lisp
    (use-package clang-format
      :ensure t
      :config)
  #+END_SRC

* Python
  #+BEGIN_SRC emacs-lisp
    (use-package elpy
      :ensure
      :config
      (elpy-enable))
  #+END_SRC
  =anaconda= for navigation and auto completion
  #+BEGIN_SRC emacs-lisp
  ;  (use-package anaconda-mode
  ;    :ensure t
  ;    :config
  ;    (add-hook 'python-mode-hook 'anaconda-eldoc-mode)
  ;    (add-hook 'python-mode-hook 'anaconda-mode))
  #+END_SRC

  =company-anaconda= as backend for company
  #+BEGIN_SRC emacs-lisp
  ;  (use-package company-anaconda
  ;    :ensure t
  ;    :config
  ;    (eval-after-load "company"
  ;      '(add-to-list 'company-backends 'company-anaconda)))
  #+END_SRC

  Use =python-mode= as major mode for python
  #+BEGIN_SRC emacs-lisp
    (use-package python-mode
      :ensure t
      :bind (("C-c C-c" . python-shell-send-buffer))
      :config
      (add-hook 'python-mode-hook 'anaconda-mode)
      (add-hook 'python-mode-hook 'anaconda-eldoc-mode)
      (add-hook 'python-mode-hook
                (lambda ()
                  (setq-default tab-width 4))))
  #+END_SRC

* Go
  Go major mode
  #+BEGIN_SRC emacs-lisp
    (use-package go-mode
      :ensure t)

    (use-package company-go
      :ensure t
      :config
      (add-hook 'go-mode-hook
                (lambda ()
                  (set (make-local-variable 'company-backends) '(company-go))
                  (company-mode))))
  #+END_SRC
* Org
  =org= with some defaults
  #+BEGIN_SRC emacs-lisp
    (use-package org
      :ensure t
      :bind (("C-c c" . org-capture)
             ("C-c a" . org-agenda))
      :config
      (add-hook 'org-capture-mode-hook 'evil-insert-state)
      (setq org-modules (append org-modules '(org-habit)))
      (setq org-habit-show-habits-only-for-today t)
      (setq org-habit-graph-column 80)
      (setq org-todo-keywords
            (quote ((sequence "TODO(t)" "NEXT(n)" "|" "DONE(d)")
                    (sequence "WAITING(w@/!)" "HOLD(h@/!)" "|" "CANCELLED(c@/!)" "PHONE" "MEETING"))))
      (setq org-todo-keyword-faces
            (quote (("TODO" :foreground "red" :weight bold)
                    ("NEXT" :foreground "blue" :weight bold)
                    ("DONE" :foreground "forest green" :weight bold)
                    ("WAITING" :foreground "orange" :weight bold)
                    ("HOLD" :foreground "magenta" :weight bold)
                    ("CANCELLED" :foreground "forest green" :weight bold)
                    ("MEETING" :foreground "forest green" :weight bold)
                    ("PHONE" :foreground "forest green" :weight bold))))
      (setq org-src-fontify-natively t)
      (setq org-src-tab-acts-natively t)
      (setq org-src-tab-acts-natively t)
      (setq org-agenda-files '("~/Dropbox/org"))
      (setq org-reveal-root (concat "file://" (getenv "HOME") "/src/reveal.js"))
      (setq org-reveal-mathjax t)
      (setq org-default-notes-file (concat org-directory "~/Dropbox/org/notes.org"))
      (setq org-src-tab-acts-natively t)
      (setq org-agenda-custom-commands
            '(
              ("h" "Daily habits"
               ((agenda ""))
               ((org-agenda-show-log t)
                (org-agenda-ndays 7)
                (org-agenda-log-mode-items '(state))
                (org-agenda-skip-function '(org-agenda-skip-entry-if 'notregexp ":DAILY:"))))
              ("c" . "My Custom Agendas")
              ("cu" "Unscheduled TODO"
               ((todo ""
                      ((org-agenda-overriding-header "\nUnscheduled TODO")
                       (org-agenda-skip-function '(org-agenda-skip-entry-if 'timestamp)))))
               nil
               nil)))
      (setq org-capture-templates
            '(("t" "Todo" entry (file+headline "~/Dropbox/org/index.org" "New Tasks")
               "* TODO %?\n"))))
  #+END_SRC

  done yesterday
  #+BEGIN_SRC emacs-lisp
    (defun org-todo-with-date (&optional arg)
      (interactive "P")
      (cl-letf* ((org-read-date-prefer-future nil)
                 (my-current-time (org-read-date t t nil "when:" nil nil nil))
                 ((symbol-function #'org-current-effective-time)
                  #'(lambda () my-current-time)))
        (org-todo arg)
        )) 
  #+END_SRC
 
  =ox-reveal= for html/js presentations
  #+BEGIN_SRC emacs-lisp
    (use-package ox-reveal
      :ensure t)

    (use-package htmlize
      :ensure t)
  #+END_SRC

  Nice =org-bullets= instead of ugly stars
  #+BEGIN_SRC emacs-lisp
    (use-package org-bullets
      :ensure t
      :config
      (setq org-ellipsis " …")
      (setq org-bullets-bullet-list '("•"))
      (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1))))
  #+END_SRC

  manage projects with =org-projectile=
  #+BEGIN_SRC emacs-lisp
    (use-package org-projectile
      :bind (("C-c n p" . org-projectile:project-todo-completing-read)
             ("C-c c" . org-capture))
      :config
      :ensure t)

  #+END_SRC

  nice reminder
  #+BEGIN_SRC emacs-lisp
    (use-package org-alert
      :ensure t
      :config
      (setq org-alert-interval 1800)
      (setq alert-default-style 'libnotify))
  #+END_SRC

  journal
  #+BEGIN_SRC emacs-lisp
    (use-package org-journal
      :ensure t
      :config
      (setq org-journal-dir "~/.journal")
      (setq org-journal-file-format "%Y-%m-%d.org"))
  #+END_SRC
  
* Git
  =magit= for git integration
  #+BEGIN_SRC emacs-lisp
    (use-package magit
      :ensure t
      :bind (("C-x g" . magit-status)))
  #+END_SRC

  show commit message of line
  #+BEGIN_SRC emacs-lisp
    (use-package git-messenger
      :ensure t
      :config
      (setq git-messenger:show-detail t)
      (setq git-messenger:use-magit-popup t))
  #+END_SRC

  show changes in buffer
  #+BEGIN_SRC emacs-lisp
    (use-package git-gutter+
      :ensure t)
  #+END_SRC
* PDF
  Docview default resolution is ugly
  #+BEGIN_SRC emacs-lisp
    (use-package doc-view
      :ensure t
      :config
      (setq doc-view-resolution 144))
  #+END_SRC

  pdf tools for searching through pdf
  #+BEGIN_SRC emacs-lisp
    (use-package pdf-tools
      ;; :ensure t
      :config
      (pdf-tools-install))
  #+END_SRC
* Multiple Cursors
  #+BEGIN_SRC emacs-lisp
    (use-package multiple-cursors
      :ensure t
      :bind (("M-SPC" . mc/mark-next-like-this)
             ("M-S-SPC" . mc/mark-previous-like-this)
             ("M-<return>" . mc/mark-all-like-this)))
  #+END_SRC

* Buffer Movement
  Use =ace-window= to move into indexed buffer
  #+BEGIN_SRC emacs-lisp
    (use-package ace-window
      :bind(("C-x o" . ace-window))
      :ensure t)
  #+END_SRC

* Calender
  #+BEGIN_SRC emacs-lisp
    (use-package calfw
      :ensure t
      :config
      (require 'calfw-org)
      (require 'calfw-ical))
  #+END_SRC
* Additional Keybindings
  Global Bindings
  #+BEGIN_SRC emacs-lisp
    (global-set-key (kbd "C-c k") 'kill-this-buffer)
    (global-set-key (kbd "C-x C-o") 'ff-find-other-file)
    (global-set-key (kbd "s-m") 'toggle-maximize-buffer)
  #+END_SRC
* Google Translate
  #+BEGIN_SRC emacs-lisp
    (use-package google-translate
      :ensure t
      :config
      (global-set-key (kbd "C-c t") 'google-translate-at-point)
      (global-set-key (kbd "C-c T") 'google-translate-query-translate))
  #+END_SRC
* Images
  for images resizing
  #+BEGIN_SRC emacs-lisp
    (use-package image-file
      :init (auto-image-file-mode))
  #+END_SRC
* Scala
  #+BEGIN_SRC emacs-lisp
    (use-package sbt-mode
      :ensure t)
    (use-package scala-mode
      :ensure t
      :config
      (setq scala-indent:step 4))
    (use-package ensime
      :ensure t)
  #+END_SRC
* YAML
  #+BEGIN_SRC emacs-lisp
    (use-package yaml-mode
      :ensure t)
  #+END_SRC
* Abrev
  #+BEGIN_SRC emacs-lisp
    (setq abbrev-file-name "~/.emacs.d/.abbrev")
  #+END_SRC
* Load private file
  #+BEGIN_SRC emacs-lisp
    (load-file "~/.emacs.d/private.el")
  #+END_SRC
* upgrade packages
  #+BEGIN_SRC emacs-lisp
    (use-package package-utils
      :ensure t)
  #+END_SRC
* run current buffer
  #+BEGIN_SRC emacs-lisp
    (defun xah-run-current-file ()
      (interactive)
      (let (
            (-suffix-map
             ;; (‹extension› . ‹shell program name›)
             `(
               ("php" . "php")
               ("pl6" . "perl6")
               ("pl" . "/home/ben/perl5/perlbrew/perls/perl-5.24.0/bin/perl")
               ("pm" . "/home/ben/perl5/perlbrew/perls/perl-5.24.0/bin/perl")
               ("py" . "python3")
               ("rb" . "ruby")
               ("go" . "go run")
               ("js" . "node") ; node.js
               ("sh" . "bash")
               ("clj" . "java -cp /home/xah/apps/clojure-1.6.0/clojure-1.6.0.jar clojure.main")
               ("rkt" . "racket")
               ("ml" . "ocaml")
               ("vbs" . "cscript")
               ("tex" . "pdflatex")
               ("latex" . "pdflatex")
               ("java" . "javac")
               ;; ("pov" . "/usr/local/bin/povray +R2 +A0.1 +J1.2 +Am2 +Q9 +H480 +W640")
               ))

            -fname
            -fSuffix
            -prog-name
            -cmd-str)

        (when (null (buffer-file-name)) (save-buffer))
        (when (buffer-modified-p) (save-buffer))

        (setq -fname (buffer-file-name))
        (setq -fSuffix (file-name-extension -fname))
        (setq -prog-name (cdr (assoc -fSuffix -suffix-map)))
        (setq -cmd-str (concat -prog-name " \""   -fname "\""))

        (cond
         ((string-equal -fSuffix "el") (load -fname))
         ((string-equal -fSuffix "java")
          (progn
            (shell-command -cmd-str "*xah-run-current-file output*" )
            (shell-command
             (format "java %s" (file-name-sans-extension (file-name-nondirectory -fname))))))
         (t (if -prog-name
                (progn
                  (message "Running…")
                  (shell-command -cmd-str "*xah-run-current-file output*" ))
              (message "No recognized program file suffix for this file."))))))
    (global-set-key (kbd "<f5>") 'xah-run-current-file)
  #+END_SRC
* rust
  #+BEGIN_SRC emacs-lisp
    (use-package rust-mode
      :ensure t
      :config
      (add-hook 'rust-mode-hook #'racer-mode))

    (use-package flycheck-rust
      :ensure t
      :config
      (add-hook 'flycheck-mode-hook #'flycheck-rust-setup))

    (use-package racer
      :ensure t)
  #+END_SRC
* chinese
  #+BEGIN_SRC emacs-lisp
    (use-package chinese-pyim
      :ensure nil
      :config
      ;; 激活 basedict 拼音词库
      (use-package chinese-pyim-basedict
        :ensure nil
        :config (chinese-pyim-basedict-enable)))
  #+END_SRC
* editor config
#+BEGIN_SRC emacs-lisp
    (use-package editorconfig
      :ensure t
      :config
      (editorconfig-mode 1))
#+END_SRC

* elfeed
  
#+BEGIN_SRC emacs-lisp
  (use-package elfeed
    :ensure t
    :config
    (evil-leader/set-key "nf" 'elfeed)
    (setq elfeed-feeds
          '("http://nullprogram.com/feed/"
            "http://www.tsinghua.edu.cn/publish/news/rss/all.xml"
            "http://planet.emacsen.org/atom.xml"))
    (add-to-list 'evil-emacs-state-modes 'elfeed-search-mode)
    (add-to-list 'evil-emacs-state-modes 'elfeed-show-mode)
    (add-to-list 'evil-emacs-state-modes 'rtags-mode)
    (define-key elfeed-show-mode-map "j" 'evil-next-line)
    (define-key elfeed-show-mode-map "k" 'evil-previous-line)
    (define-key elfeed-search-mode-map "j" 'evil-next-line)
    (define-key elfeed-search-mode-map "k" 'evil-previous-line))

  (use-package elfeed-goodies
    :ensure t
    :config
    (elfeed-goodies/setup)
    (evil-define-key 'evilified elfeed-show-mode-map "o" 'elfeed-goodies/show-ace-link))

  (use-package elfeed-org
    :ensure t)

#+END_SRC
* evil
  #+BEGIN_SRC emacs-lisp
    (use-package evil
      :ensure t
      :config
      (define-key evil-normal-state-map (kbd "C-u") 'evil-scroll-up)
      (define-key evil-normal-state-map (kbd "g f") 'imenu)
      (define-key evil-normal-state-map (kbd "g D") 'dumb-jump-go)
      (evil-define-key 'normal c-mode-map (kbd "g d") 'rtags-find-symbol-at-point)
      (evil-define-key 'normal c++-mode-map (kbd "g d") 'rtags-find-symbol-at-point)
      (evil-define-key 'normal rust-mode-map (kbd "g d") 'racer-find-definition)
      (evil-define-key 'normal c-mode-map (kbd "g t") 'rtags-symbol-type)
      (evil-define-key 'normal c++-mode-map (kbd "g t") 'rtags-symbol-type)
      (evil-define-key 'normal c-mode-map (kbd "g r") 'rtags-find-references-at-point)
      (evil-define-key 'normal c++-mode-map (kbd "g r") 'rtags-find-references-at-point)
      (evil-define-key 'normal go-mode-map (kbd "g d") 'godef-jump)
      (evil-leader/set-key-for-mode 'c++-mode "r" 'rtags-rename-symbol)
      (evil-leader/set-key-for-mode 'c++-mode "a" 'rtags-find-references-at-point)
      (evil-mode 1))

    (use-package evil-escape
      :ensure t
      :config
      (setq-default evil-escape-key-sequence "fd")
      (setq-default evil-escape-delay 0.2)
      (evil-escape-mode))

    (use-package evil-leader
      :ensure t
      :config
      (global-evil-leader-mode)
      (evil-leader/set-leader "<SPC>")
      (evil-leader/set-key-for-mode 'org-mode 
        "s" 'org-schedule
        "r" 'org-toggle-latex-fragment
        "d" 'org-deadline
        "$" 'org-archive-subtree
        "c" 'org-set-category-property
        "P" 'org-set-property
        "t" 'org-set-tags)
      (evil-leader/set-key
        "sh" 'split-window-below
        "sv" 'split-window-right
        "ms" 'magit-status
        "ml" 'magit-log
        "mp" 'git-messenger:popup-message
        "mb" 'magit-log-buffer-file
        "ci" 'evilnc-comment-or-uncomment-lines
        "cl" 'evilnc-quick-comment-or-uncomment-to-the-line
        "ll" 'evilnc-quick-comment-or-uncomment-to-the-line
        "cc" 'evilnc-copy-and-comment-lines
        "cp" 'evilnc-comment-or-uncomment-paragraphs
        "cr" 'comment-or-uncomment-region
        "cv" 'evilnc-toggle-invert-comment-line-by-line
        "\\" 'evilnc-comment-operator
        "pf" 'projectile-find-file
        "pp" 'projectile-switch-project
        "ps" 'ag-project
        "pc" 'projectile-compile-project
        "pt" 'projectile-test-project
        "pa" 'projectile-ag
        "oa" 'org-agenda
        "oc" 'org-capture
        "oj" 'org-journal-new-entry
        "TAB" 'ace-window
        "k"  'kill-this-buffer
        "e" 'find-file
        "b" 'switch-to-buffer))

    (use-package org-evil
      :ensure t
      :config
      (define-key org-agenda-mode-map "j" 'evil-next-line)
      (define-key org-agenda-mode-map "k" 'evil-previous-line)
      (evil-define-key 'normal org-evil-mode-map
        "-" 'org-cycle-list-bullet
        "H" 'org-metaleft
        "J" 'org-metaup
        "K" 'org-metadown
        "L" 'org-metaleft))

    (use-package evil-surround
      :ensure t
      :config
      (global-evil-surround-mode 1))

    (use-package evil-nerd-commenter
      :ensure t
      :config
      (evilnc-default-hotkeys))

    (use-package evil-magit
      :ensure t)

    (use-package evil-snipe
      :ensure t
      :config
      (evil-snipe-mode 1)
      (setq evil-snipe-scope 'whole-visible)
      (add-hook 'magit-mode-hook 'turn-off-evil-snipe-override-mode))

    (use-package evil-cleverparens
      :ensure t)

    (use-package evil-multiedit
      :ensure t
      :config
      ;; Highlights all matches of the selection in the buffer.
      (define-key evil-visual-state-map "R" 'evil-multiedit-match-all)

      ;; Match the word under cursor (i.e. make it an edit region). Consecutive presses will
      ;; incrementally add the next unmatched match.
      (define-key evil-normal-state-map (kbd "M-d") 'evil-multiedit-match-and-next)
      ;; Match selected region.
      (define-key evil-visual-state-map (kbd "M-d") 'evil-multiedit-match-and-next)

      ;; Same as M-d but in reverse.
      (define-key evil-normal-state-map (kbd "M-D") 'evil-multiedit-match-and-prev)
      (define-key evil-visual-state-map (kbd "M-D") 'evil-multiedit-match-and-prev)

      ;; OPTIONAL: If you prefer to grab symbols rather than words, use
      ;; `evil-multiedit-match-symbol-and-next` (or prev).

      ;; Restore the last group of multiedit regions.
      (define-key evil-visual-state-map (kbd "C-M-D") 'evil-multiedit-restore)

      ;; RET will toggle the region under the cursor
      (define-key evil-multiedit-state-map (kbd "RET") 'evil-multiedit-toggle-or-restrict-region)

      ;; ...and in visual mode, RET will disable all fields outside the selected region
      (define-key evil-visual-state-map (kbd "RET") 'evil-multiedit-toggle-or-restrict-region)

      ;; For moving between edit regions
      (define-key evil-multiedit-state-map (kbd "C-n") 'evil-multiedit-next)
      (define-key evil-multiedit-state-map (kbd "C-p") 'evil-multiedit-prev)
      (define-key evil-multiedit-insert-state-map (kbd "C-n") 'evil-multiedit-next)
      (define-key evil-multiedit-insert-state-map (kbd "C-p") 'evil-multiedit-prev)

      ;; Ex command that allows you to invoke evil-multiedit with a regular expression, e.g.
      (evil-ex-define-cmd "ie[dit]" 'evil-multiedit-ex-match))

    (use-package evil-smartparens
      :ensure t
      :config
      (add-hook 'smartparens-enabled-hook #'evil-smartparens-mode))
  #+END_SRC
* jumping
  jumping with ag and grep
#+BEGIN_SRC emacs-lisp  
  (use-package dumb-jump
    :ensure t
    :config
  (eval-after-load 'evil
    (eval-after-load 'dumb-jump
      (defadvice dumb-jump-go (before dotemacs activate)
        (evil--jumps-push)))))
#+END_SRC

  jumping with avy
#+BEGIN_SRC emacs-lisp
  (use-package avy
    :ensure t
    :bind (
    ("M-l" . avy-goto-line)
    ("M-w" . avy-goto-word-1)))
#+END_SRC

* gnus, mail, ...
  #+BEGIN_SRC emacs-lisp
    (use-package gnus
      :ensure t
      :config
      (setq gnus-select-method '(nnnil ""))
      (setq gnus-secondary-select-methods '((nnml "")))
      (add-hook 'gnus-group-mode-hook 'gnus-topic-mode)
      (setq gnus-mime-display-multipart-related-as-mixed t)
      (setq smiley-style 'medium)
      (setq user-mail-address "bernhard@specht.net"
            user-full-name    "Bernhard Specht")
      (setq-default
       gnus-summary-line-format "%U%R%z %(%&user-date;  %-15,15f  %B (%c) %s%)\n"
       gnus-user-date-format-alist '((t . "%Y-%m-%d %H:%M"))
       gnus-group-line-format "%M%S%p%P%5y:%B %G\n";;"%B%(%g%)"
       gnus-summary-thread-gathering-function 'gnus-gather-threads-by-references
       gnus-thread-sort-functions '(gnus-thread-sort-by-most-recent-date)
       gnus-ignored-newsgroups "^to\\.\\|^[0-9. ]+\\( \\|$\\)\\|^[\”]\”[#’()]"
       gnus-sum-thread-tree-false-root ""
       gnus-sum-thread-tree-indent " "
       gnus-sum-thread-tree-leaf-with-other "├► "
       gnus-sum-thread-tree-root ""
       gnus-sum-thread-tree-single-leaf "╰► "
       gnus-sum-thread-tree-vertical "│"
       gnus-article-browse-delete-temp t
       gnus-fetch-old-headers t
       gnus-treat-strip-trailing-blank-lines 'last
       gnus-keep-backlog 'nil
       gnus-summary-display-arrow nil ; Don't show that annoying arrow:
       gnus-mime-display-multipart-related-as-mixed t ; Show more MIME-stuff:
       gnus-auto-select-first nil ; Don't get the first article automatically:
       smiley-style 'medium
       gnus-keep-backlog '0))
  #+END_SRC
* irc
  #+BEGIN_SRC emacs-lisp
    (use-package erc
      :ensure t
      :config
      ;(setq erc-autojoin-channels-alist
      ;      '(("freenode.net" "#moarvm" "#perl6")))
      (require 'erc-services)
      (erc-services-mode 1)
      (add-to-list 'erc-modules 'notifications)
      (setq erc-prompt-for-nickserv-password t)
      (with-eval-after-load "erc"
        (erc :server "irc.freenode.net" :port 6667 :nick "spebern")))
  #+END_SRC
* highlighting variables
  #+BEGIN_SRC emacs-lisp
    (use-package highlight-symbol
      :ensure t)
  #+END_SRC
